// AUTO-GENERATED BY kocha build
// DO NOT EDIT THIS FILE
package main

import (
	"github.com/woremacx/kocha"
	"github.com/woremacx/kocha/util"
	"io/ioutil"
	config "{{.configImportPath}}"
	"os"
	"text/template"
)

const (
	mainTemplate = {{.mainTemplate|printf "%q"}}
)

func main() {
	funcMap := template.FuncMap{
		"goString": util.GoString,
	}
	t := template.Must(template.New("main").Funcs(funcMap).Parse(mainTemplate))
	file, err := os.Create("{{.mainFilePath}}")
	if err != nil {
		panic(err)
	}
	defer file.Close()
	app, err := kocha.New(config.AppConfig)
	if err != nil {
		panic(err)
	}
	res := map[string]string{
		{{range $name, $path := .resources}}
		"{{$name}}": "{{$path}}",
		{{end}}
	}
	resources := make(map[string]string)
	for name, path := range res {
		buf, err := ioutil.ReadFile(path)
		if err != nil {
			panic(err)
		}
		resources[name] = util.Gzip(string(buf))
	}
	data := map[string]interface{}{
		"app":                   app,
		"configImportPath":      "{{.configImportPath}}",
		"dbImportPath":          "{{.dbImportPath}}",
		"migrationImportPath":  "{{.migrationImportPath}}",
		"resources":             resources,
		"version":               "{{.version}}",
	}
	if err := t.Execute(file, data); err != nil {
		panic(err)
	}
}
